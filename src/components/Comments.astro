---
import * as yaml from 'yaml';
import * as fs from 'fs';
import * as path from 'path';

interface Props {
  postSlug: string;
}

interface Comment {
  id: number;
  author: string;
  date: string;
  content: string;
  parent: number | null;
}

const { postSlug } = Astro.props;

// Load comments from YAML file
let comments: Comment[] = [];
const commentsFile = path.join(process.cwd(), 'src', 'data', 'comments', `${postSlug}.yml`);

if (fs.existsSync(commentsFile)) {
  const content = fs.readFileSync(commentsFile, 'utf-8');
  comments = yaml.parse(content) || [];
}

// Sort by date
comments.sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime());

function formatDate(dateStr: string): string {
  return new Date(dateStr).toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
  });
}
---

{comments.length > 0 && (
  <div class="comments-section">
    <h3 class="comments-title">
      <span class="title-prefix">//</span> 
      {comments.length} Comment{comments.length !== 1 ? 's' : ''}
    </h3>
    <div class="comments-list">
      {comments.map((comment) => (
        <div class="comment" id={`comment-${comment.id}`}>
          <div class="comment-header">
            <div class="comment-avatar">
              {comment.author.charAt(0).toUpperCase()}
            </div>
            <div class="comment-meta">
              <span class="comment-author">{comment.author}</span>
              <span class="comment-date">{formatDate(comment.date)}</span>
            </div>
          </div>
          <div class="comment-content">
            {comment.content}
          </div>
        </div>
      ))}
    </div>
  </div>
)}

<style>
  .comments-section {
    margin-top: var(--space-xl);
  }

  .comments-title {
    font-size: 1.25rem;
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    margin-bottom: var(--space-lg);
  }

  .title-prefix {
    color: var(--accent-primary);
    font-family: var(--font-mono);
  }

  .comments-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
  }

  .comment {
    padding: var(--space-lg);
    background: var(--bg-card);
    border: var(--border-subtle);
    border-left: 3px solid var(--accent-primary);
    border-radius: var(--radius-md);
  }

  .comment-header {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    margin-bottom: var(--space-md);
  }

  .comment-avatar {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: var(--font-display);
    font-weight: 700;
    font-size: 1rem;
    color: var(--bg-primary);
  }

  .comment-meta {
    display: flex;
    flex-direction: column;
  }

  .comment-author {
    font-weight: 600;
    color: var(--text-primary);
  }

  .comment-date {
    font-family: var(--font-mono);
    font-size: 0.75rem;
    color: var(--text-muted);
  }

  .comment-content {
    color: var(--text-secondary);
    line-height: 1.6;
    white-space: pre-wrap;
  }
</style>
