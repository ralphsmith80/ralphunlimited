---
import * as yaml from 'yaml';
import * as fs from 'fs';
import * as path from 'path';

interface Props {
  postSlug: string;
}

interface Comment {
  id: number;
  author: string;
  date: string;
  content: string;
  parent: number | null;
}

const { postSlug } = Astro.props;

// Load comments from YAML file
let comments: Comment[] = [];
const commentsFile = path.join(process.cwd(), 'src', 'data', 'comments', `${postSlug}.yml`);

if (fs.existsSync(commentsFile)) {
  const content = fs.readFileSync(commentsFile, 'utf-8');
  comments = yaml.parse(content) || [];
}

// Sort by date
comments.sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime());

function formatDate(dateStr: string): string {
  return new Date(dateStr).toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  });
}
---

{comments.length > 0 && (
  <div class="comments-section">
    <h3>{comments.length} Comment{comments.length !== 1 ? 's' : ''}</h3>
    <div class="comments-list">
      {comments.map((comment) => (
        <div class="comment" id={`comment-${comment.id}`}>
          <div class="comment-header">
            <span class="comment-author">{comment.author}</span>
            <span class="comment-date">{formatDate(comment.date)}</span>
          </div>
          <div class="comment-content">
            {comment.content}
          </div>
        </div>
      ))}
    </div>
  </div>
)}

<style>
  .comments-section {
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 1px solid #eee;
  }

  .comments-section h3 {
    margin-bottom: 1.5rem;
  }

  .comments-list {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .comment {
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 8px;
    border-left: 3px solid #0066cc;
  }

  .comment-header {
    display: flex;
    gap: 1rem;
    align-items: baseline;
    margin-bottom: 0.5rem;
  }

  .comment-author {
    font-weight: 600;
    color: #333;
  }

  .comment-date {
    font-size: 0.75rem;
    color: #666;
  }

  .comment-content {
    color: #444;
    line-height: 1.6;
  }

  @media (prefers-color-scheme: dark) {
    .comments-section {
      border-top-color: #333;
    }

    .comment {
      background: #1a1a1a;
    }

    .comment-author {
      color: #fff;
    }

    .comment-date {
      color: #999;
    }

    .comment-content {
      color: #ccc;
    }
  }
</style>
